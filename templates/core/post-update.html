{% extends 'base.html' %}
{% load static %}

{% block title %}
{{ post.pk }}
{% endblock title %}

{% block meta_head %}
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:title" content="{% if post.caption %}{{ post.caption }}{% else %}{{ post.body|truncatechars:60 }}{% endif %}">
    <meta property="og:description" content="{% if post.caption %}{{ post.caption }}{% else %}{{ post.body|truncatechars:100 }}{% endif %} by {{ post.user.username }}">
    {% for i in post.media.all %}
        {% if i.content_type == 'image' %}
            <meta property="og:image" content="{{ i.file.url }}">
        {% endif %}
    {% endfor %}
    {% for i in post.media.all %}
        {% if i.content_type == 'video' %}
            <meta property="og:video" content="{{ i.file.url }}">
        {% endif %}
    {% endfor %}

    <style>
        .post-media-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1.5rem;
            width: 100%;
            overflow: hidden;
        }
        .post-media-wrapper img,
        .post-media-wrapper video {
            max-width: 100%;
            max-height: 340px;
            width: auto;
            height: auto;
            border-radius: 12px;
            object-fit: cover;
            display: block;
            margin: 0 auto;
            background: #f4f6fb;
        }
        .replies-section {
        margin-left: 2.5rem;
        margin-top: 1.2rem;
        border-left: 3px solid #e0e4ea;
        padding-left: 1.2rem;
        }
        .reply-item {
            background: #f9fafc;
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(76,99,255,0.06);
            padding: 1rem 1.2rem 0.8rem 1.2rem;
            margin-bottom: 1.1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.9rem;
            transition: box-shadow 0.18s, border 0.18s;
            border: 1.5px solid #e0e4ea;
            position: relative;
        }
        .reply-item:hover {
            box-shadow: 0 6px 24px rgba(76,99,255,0.13);
            border-color: #6c63ff;
        }
        .reply-item .avatar {
            margin-top: 0.1rem;
        }
        .reply-content {
            flex: 1;
            background: none;
            border-radius: 0;
            box-shadow: none;
            padding: 0;
        }
        .reply-content h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #222;
            margin-bottom: 0.1rem;
            margin-top: 0;
            display: inline-block;
        }
        .reply-content .reply-meta {
            font-size: 0.88rem;
            color: #888;
            margin-left: 0.7rem;
            font-weight: 400;
        }
        .reply-content p {
            color: #444;
            font-size: 0.97rem;
            margin: 0.2rem 0 0.3rem 0;
            font-weight: 500;
        }
        .reply-content small {
            color: #6c63ff;
            font-size: 0.89rem;
            font-weight: 500;
        }
    </style>
{% endblock meta_head %}
{% block body %}

    <!-- main content -->
    <div class="main-content right-chat-active">
        
        <div class="middle-sidebar-bottom">
            <div class="middle-sidebar-left pe-0 ps-lg-3 ms-0 me-0" style="max-width: 100%;">

                <div class="col">
                    <div class="card w-100 shadow-xss rounded-xxl border-0 p-4">
                        <div class="card-body p-0 d-flex">
                            <figure class="avatar me-3"><img src="{{ post.user.img.url }}" alt="image" class="shadow-sm rounded-circle w45"></figure>
                            <h4 class="fw-700 text-grey-900 font-xssss mt-1">{{ post.user.username }} 
                                {% if i.user.verified %}
                                    <i class="feather-check bg-success font-xs" style='border-radius:50px;'></i>
                                {% endif %}
                                {% if i.user.is_admin %}
                                    <i class="feather-check  font-xs" style='border-radius:50px; background-color: #FDD017'></i>

                                {% endif %}
                                <span class="d-block font-xssss fw-500 mt-1 lh-3 text-grey-500">{{ post.created_at|timesince }} ago</span></h4>
                            <a href="#" class="ms-auto" id="dropdownMenu6" data-bs-toggle="dropdown" aria-expanded="false"><i class="ti-more-alt text-grey-900 btn-round-md bg-greylight font-xss"></i></a>
                            <div class="dropdown-menu dropdown-menu-end p-4 rounded-xxl border-0 shadow-lg" aria-labelledby="dropdownMenu6">
                                <div class="card-body p-0 d-flex">
                                    <i class="feather-trash text-grey-500 me-3 font-lg"></i>
                                    <a href="{% url 'post-delete' post.pk %}"><h4 class="fw-600 text-grey-900 font-xssss mt-0 me-4">Delete <span class="d-block font-xsssss fw-500 mt-1 lh-3 text-grey-500">Delete Your Post</span></h4></a>
                                </div>
                            </div>
                        </div>
                        
                        {% if post.body %}
                            <div class="card-body p-0 me-lg-5">
                                <p class="fw-500 text-grey-500 lh-26 font-xssss w-100">{{post.body}}</p>
                            </div>
                        {% else %}
                            {% if post.caption %}
                                <div class="card-body p-0 me-lg-5">
                                    <p class="fw-500 text-grey-500 lh-26 font-xssss w-100">{{post.caption}}</p>
                                </div>
                            {% endif %}

                            {% for i in post.media.all %}
                                <div class="post-media-wrapper">
                                    {% if i.content_type == 'image' %}
                                        <a href="{{ i.file.url }}" data-lightbox="roadtri"><img src="{{i.file.url}}" alt="image"></a>
                                    {% elif i.content_type == 'video' %}
                                        <video controls>
                                            <source src="{{i.file.url}}" type="video/mp4">
                                        </video>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% endif %}

                        <div class="card-body d-flex p-0">
                            <a href="{% url 'like' post_content_type_id post.id %}" class="d-flex align-items-center fw-600 text-grey-900 text-dark lh-26 font-xssss me-3"><i class="feather-thumbs-up text-white bg-primary-gradiant me-1 btn-round-xs font-xss"></i> {{post.like_count}} Like</a>
                            <a class="d-flex align-items-center fw-600 text-grey-900 text-dark lh-26 font-xssss"><i class="feather-message-circle text-dark text-grey-900 btn-round-sm font-lg"> </i><span id="comment-count-{{ post.id }}"> {{ post.comments.all.count }} </span> Comment </a>
                            <a href="#" id="dropdownMenu31" data-bs-toggle="dropdown" aria-expanded="false" class="ms-auto d-flex align-items-center fw-600 text-grey-900 text-dark lh-26 font-xssss"><i class="feather-share-2 text-grey-900 text-dark btn-round-sm font-lg"></i><span class="d-none-xs">Share</span></a>
                            <div class="dropdown-menu dropdown-menu-end p-4 rounded-xxl border-0 shadow-lg" aria-labelledby="dropdownMenu31">
                                <h4 class="fw-700 font-xss text-grey-900 d-flex align-items-center">Share <i class="feather-x ms-auto font-xssss btn-round-xs bg-greylight text-grey-900 me-2"></i></h4>
                                <div class="card-body p-0 d-flex">
                                    <ul class="d-flex align-items-center justify-content-between mt-2">
                                        <li class="me-1"><a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" 
                                        target="_blank" class="btn-round-lg bg-facebook"><i class="font-xs ti-facebook text-white"></i></a></li>
                                        <li><a href="https://wa.me/?text={{ post.caption|urlencode }}%20{{ request.build_absolute_uri|urlencode }}" 
                                        target="_blank" class="btn-round-lg bg-whatsup ms-2"><i class="font-xs feather-phone text-white"></i></a></li>
                                        <li class="me-1">
                                            <button class='btn'><i onclick="copyToClipboard('{{request.build_absolute_uri}}')" class="feather-link btn-round-lg bg-secondary font-xs text-white"></i>
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div><hr>
                    </div>
                </div>

                <form method='POST' action='{% url "post-update" post.pk %}' enctype='multipart/form-data' class="chat-form">
                    {% csrf_token %}
                    <div class="card w-100 shadow-xss rounded-xxl border-0 p-4 mb-3">
                        <div class="card-body p-0 mt-3 position-relative">
                            <figure class="avatar position-absolute ms-2 mt-1 top-5"><img src="{{post.user.img.url}}" alt="image" class="shadow-sm rounded-circle w30"></figure>
                            <textarea name="body" class="h100 bor-0 w-100 rounded-xxl p-2 ps-5 font-xssss text-grey-500 fw-500 border-light-md theme-dark-bg" cols="30" rows="10" placeholder="What's on your mind?">{% if post.body %}{{post.body}}{% endif %}</textarea>
                            <input name='caption' {% if post.caption %}value='{{post.caption}}'{% endif %} type="text" class='form-control border-dark-md theme-dark-bg mb-2' placeholder="Caption...">
                            <input name='tags' type="text" class='form-control border-dark-md theme-dark-bg' placeholder="Tags">
                        </div>
                        <div class="card-body d-flex p-0 mt-3">
                            <div class="d-flex align-items-center">
                                <i class="font-lg text-success feather-image me-2"></i>
                                <input name="files" multiple='true' type="file" class="form-control-file">
                            </div>
                            <button class="btn btn-primary ms-auto"><i class="ti-arrow-right text-white me-2"></i></button>
                        </div>
                    </div>
                </form>

                <div class="row">
                    <div class="col-lg-12 position-relative">
                        <div class="chat-wrapper pt-0 w-100 position-relative scroll-bar bg-white theme-dark-bg">
                            <div class="chat-body p-3 ">
                                <div id="comments-{{ post.id }}" class="messages-content pb-5">
                                    {% for i in comments %}
                                        <div class="comment-item d-flex mb-3">
                                            <figure class="avatar me-3">
                                                <img src="{{i.user.img.url}}" alt="image" class="shadow-sm rounded-circle w35">
                                            </figure>
                                            <div class="comment-content bg-lightblue rounded-xxl p-2 w-100">
                                                <div class="d-flex justify-content-between">
                                                    <a href="{% url 'profile' i.user.slug %}"><h4 class="fw-700 text-grey-900 font-xssss mt-1">{{ i.user.username }}
                                                        {% if i.user.verified %}
                                                            <i class="feather-check bg-success font-xs" style='border-radius:50px;'></i>
                                                        {% endif %}
                                                        {% if i.user.is_admin %}
                                                                                                                        <i class="feather-check  font-xs" style='border-radius:50px; background-color: #FDD017'></i>

                                                        {% endif %}
                                                    </h4></a>
                                                    <span class="font-xssss fw-500 text-grey-500">{{ i.updated_at|timesince }} ago</span>
                                                </div>
                                                <p class="fw-500 text-grey-800 font-xssss lh-20 mt-1 mb-0">{{ i.comment }}</p>
                                                
                                                <div class="comment-actions mt-2">
                                                    <a href="{% url 'like' comment_content_type_id i.id %}" class="d-flex align-items-center fw-600 text-grey-900 text-dark lh-26 font-xssss me-3"><i class="feather-thumbs-up text-white bg-primary-gradiant me-1 btn-round-xs font-xss"></i> {{i.like_count}} Like</a>
                                                    <button class="btn btn-sm btn-secondary reply-btn" data-comment-id="{{ i.id }}">Reply</button>
                                                    
                                                    {% if i.replies.exists %}
                                                        <button class="btn ms-3 btn-sm btn-outline-dark" 
                                                                onclick="toggleReplies('replies-{{ i.id }}')"
                                                                data-replies="{{ i.id }}"
                                                                data-count="{{ i.replies.count }}">
                                                            {{ i.replies.count }} replies
                                                        </button>
                                                    {% endif %}
                                                    
                                                    {% if request.user == post.user or request.user == i.user %}
                                                        <div class="dropdown ms-auto">
                                                            <a href="#" id="dropdownMenu{{ i.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                                                <i class="ti-more-alt text-grey-900 btn-round bg-greylight"></i>
                                                            </a>
                                                            <div class="dropdown-menu dropdown-menu-end p-4 rounded-xxl border-0 shadow-lg" aria-labelledby="dropdownMenu{{ i.id }}">
                                                                {% if request.user == post.user or request.user == i.user or request.user.is_admin %}
                                                                    <div class="card-body p-0 d-flex">
                                                                        <i class="feather-trash text-grey-500 me-3 font-lg"></i>
                                                                        <a href="{% url 'comment-delete' i.pk %}"><h4 class="fw-600 text-grey-900 font-xssss mt-0 me-4">Delete <span class="d-block font-xsssss fw-500 mt-1 lh-3 text-grey-500">Delete Your comment</span></h4></a>
                                                                    </div>
                                                                {% endif %}
                                                                
                                                                {% if request.user == i.user %}
                                                                    <div class="card-body p-0 d-flex mt-2">
                                                                        <i class="feather-alert-circle text-grey-500 me-3 font-lg"></i>
                                                                        <a href="{% url 'comment-update' i.pk %}"><h4 class="fw-600 text-grey-900 font-xssss mt-0 me-4">Edit <span class="d-block font-xsssss fw-500 mt-1 lh-3 text-grey-500">Edit Your comment</span></h4></a>
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                </div>

                                                <div class="reply-form mt-3" id="reply-form-{{ i.id }}" style="display: none;">
                                                    <form id="reply-form-ajax-{{ i.id }}" action='{% url "create-comment" %}' method='POST' class="ajax-comment-form">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="post_id" value='{{post.id}}'>
                                                        <input type="hidden" name="parent" value='{{i.id}}'>
                                                        <input name="comment" class="form-control mb-2" placeholder="Write your reply...">
                                                        <button type="submit" class="btn btn-sm btn-primary" >Post</button>
                                                        <button type="button" class="btn btn-sm btn-secondary cancel-reply">Cancel</button>
                                                        <div class="comment-success"></div>
                                                        <div class="comment-error"></div>
                                                    </form>
                                                </div>
                                                
                                                <div id="replies-{{ i.id }}" class="replies-section mt-3 " style="display: none;">
                                                    {% for reply in i.replies.all %}
                                                        <div class="reply-item d-flex mb-3 ms-5">
                                                            <figure class="avatar me-2">
                                                                <img src="{{ reply.user.img.url }}" alt="image" class="shadow-sm rounded-circle w30">
                                                            </figure>
                                                            <div class="reply-content bg-lightblue rounded-xxl p-2">
                                                                <div class="d-flex justify-content-between">
                                                                    <a href="{% url 'profile' reply.user.slug %}"><h4 class="fw-700 text-grey-900 font-xssss mt-1">{{ reply.user.username }}</h4></a>
                                                                    <span class="font-xssss fw-500 text-grey-500">{{ reply.created_at|timesince }} ago</span>
                                                                </div>
                                                                <p class="fw-500 text-grey-800 font-xssss lh-20 mt-1 mb-0">{{ reply.comment }}</p>
                                                                <small class="text-muted">Replying to <b>{{ i.user.username }}</b></small>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                    <div class="clearfix"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chat-bottom dark-bg p-3 shadow-none theme-dark-bg" style="width: 98%;">
                            <form  class="chat-form" method='POST' action='{% url "create-comment" %}'>
                                {% csrf_token %}
                                <div class="d-flex">
                                    <input name="post_id" type="hidden" value="{{ post.id }}">
                                    <input name="comment" type="text" class="form-control border-dark-md theme-dark-bg" placeholder="Leave Your Comment...">
                                    <button type="submit" class="btn"> <i class="feather-send mb-1 text-white font-md text-white position-absolute" style="bottom: 35px;right:30px;"></i></button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
                
        </div>            
    </div>
{% endblock body %}