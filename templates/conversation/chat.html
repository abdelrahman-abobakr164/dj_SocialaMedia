{% extends 'conversation/base.html' %}
{% block title %}
Chat / {{ chat.id }}
{% endblock title %}

{% block style %}
<style>
    .scroll-to-bottom-btn {
        position: fixed;
        bottom: 150px;
        right: 30px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 1000;
        opacity: 0.9;
        transition: all 0.3s ease;
    }

    .scroll-to-bottom-btn:hover {
        opacity: 1;
        transform: scale(1.1);
    }

    .scroll-to-bottom-btn i {
        font-size: 18px;
    }
</style>
{% endblock style %}

{% block body %}

    <div class="main-content right-chat-activ ">
        <div class="middle-sidebar-bottom">
            <div class="middle-sidebar-left pe-0 ps-lg-3 ms-0 me-0" style="max-width: 100%;">
                <div class="row">
                    <div class="col-lg-12 position-relative">
                        <div class=" bg-white shadow-xs border-0">
                            {% if chat.is_group %}
                                <div class="d-flex">
                                    {% if chat.group_image %}
                                        <img src="{{chat.group_image.url}}" style='border-radius:50%; max-height:60px; margin-right:15px' alt="">
                                    {% else %}
                                        <i style='margin-top:20px ; margin-right:15px;' class="feather-users text-dark font-xl ms-1 rounded-circle"></i>
                                    {% endif %}
                                    <h3 class='mt-4'><a href="{% url 'edit_group' chat.pk %}" style='color:black'>{{chat.group_name}}</a></h3>
                                    <button class='btn btn-danger' style='margin-left:auto; margin-right:20px'><a style='color:black' href="{% url 'leave' chat.pk %}">Leave</a></button>
                                </div>
                            {% else %}
                                {% for user_image in chat.participants.all %}
                                    {% if user_image != request.user %}
                                        <div class="d-flex">
                                            <img src="{{user_image.img.url}}" style='border-radius:50%; max-height:60px; margin-right:15px' alt="">
                                            <h3 class='mt-4'><a href="{% url 'profile' user_image.username %}" style='color:black'>{{user_image.username}}</a></h3>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}

                        </div>
                        <div class="chat-wrapper pt-0 w-100 position-relative scroll-bar bg-white theme-dark-bg"style='height: 500px; overflow-y: auto;'>
                            <div id="chat-body" class="chat-body p-3 ">
                            {% for msg in msgs %}
                                <div class="messages-content pb-5 mb-3">
                                    {% if msg.sender != request.user %}
                                        <div class="message-item">
                                            <div class="message-user">
                                                <a href="{% url 'profile' msg.sender.slug %}">
                                                <figure class="avatar">
                                                    <img src="{{ msg.sender.img.url }}" alt="image">
                                                </figure></a>
                                                <div>
                                                    <h5>{{ msg.sender.username }}
                                                        {% if msg.sender.verified %}
                                                            <i class="feather-check bg-success font-xs" style='border-radius:50px;'></i>
                                                        {% endif %}
                                                        
                                                        {% if msg.sender.is_admin %}
                                                            <i class="feather-check font-xs" style='border-radius:50px; background-color: #FDD017'></i>
                                                        {% endif %}
                                                    </h5>
                                                    <div class="time">{{ msg.timestamp|time:"g:i:a" }}</div>
                                                </div>
                                            </div>

                                            {% for att in msg.attachments.all %}
                                                {% if att.file_type == 'image' %}
                                                    <div class="card-body d-block p-0 mb-3">
                                                        <div class="row ps-2 pe-2">
                                                            <div class="col p-1"><a href="{{ att.file.url }}" data-lightbox="roadtri"><img style='max-height: 200px; max-width: 170px' src="{{att.file.url}}" class="rounded-3 w-100" alt="image"></a>
                                                                {% if request.user.verified or request.user.is_admin %}
                                                                    <a href="{{ att.file.url }}"  style='color:black' download><i class="feather-download font-xs"></i></a>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% elif att.file_type == 'video' %}
                                                    <div class="card-body p-0 mb-3 rounded-3 overflow-hidden">
                                                        <div class="row ps-2 pe-2">
                                                            <div class=" col-sm p-1">
                                                                <video controls style='max-height: 400px'>
                                                                    <source src="{{ att.file.url }}" type="video/mp4">
                                                                </video>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    <div class="card-body d-block p-0 mb-3">
                                                        <div class="row ps-2 pe-2">
                                                            <div class="col p-1"><a style='color:black' href="{{ att.file.url }}"><i class="ti-file " style='margin-left:15%; font-size: 80px'></i></a></div>
                                                        </div>
                                                    </div>
                                                    <div >{{ att.file_name}}</div>
                                                {% endif %}
                                            {% endfor %}

                                            {% if msg.content %}
                                                <div class="message-wrap me-2">{{ msg.content }}</div>
                                            {% endif %}
                                        </div>

                                    {% elif msg.sender == request.user %}
                                        <div class="message-item outgoing-message">
                                            {% for att in msg.attachments.all %}
                                                {% if att.file_type == 'image' %}
                                                    <div class="card-body d-block p-0 mb-3">
                                                        <div class="row ps-2 pe-2">
                                                            <div class="col p-1"><a href="{{ att.file.url }}" data-lightbox="roadtri"><img style='max-height: 200px; max-width: 170px' src="{{att.file.url}}" class="rounded-3 w-100" alt="image"></a></div>
                                                        </div>
                                                    </div>
                                                    
                                                {% elif att.file_type == 'video' %}
                                                    <div class="card-body p-0 mb-3 rounded-3 overflow-hidden">
                                                        <div class="row ps-2 pe-2">
                                                            <div class=" col-sm p-1">
                                                                <video controls style='max-height: 400px'>
                                                                    <source src="{{ att.file.url }}" type="video/mp4">
                                                                </video>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    <div class="card-body d-block p-0 mb-3">
                                                        <div class="row ps-2 pe-2">
                                                            <div class="col p-1"><a style='color:black' href="{{ att.file.url }}"><i class="ti-file " style='float:right; font-size: 80px'></i></a></div>
                                                        </div>
                                                    </div>
                                                    <div >{{ att.file_name}}</div>
                                                {% endif %}
                                            {% endfor %}

                                            {% if msg.content %}
                                                <div class="message-wrap">{{ msg.content }}</div>
                                            {% endif %}  

                                            <div class="message-user">
                                                <div class="time">{{ msg.timestamp|time:"g:i:a" }}<i class="ti-double-check {% if msg.read == True %}text-info{% else %}{% endif %}"></i></div>
                                                <button type="button" class="btn ms-2 btn-xss">
                                                    <a href="{% url 'delete-chat' msg.id %}"><i class="feather-trash text-danger font-xss"></i></a>
                                                </button>
                                            </div>
                                        </div>
                                    {% endif %}
                                    <div class="clearfix"></div>
                                </div>
                            {% endfor %}
                            </div>

                            <button id="scrollToBottomBtn" class="scroll-to-bottom-btn" title="Scroll to bottom">
                                <i class="ti-arrow-down"></i>
                            </button>
                        </div>
                        <div class="chat-bottom dark-bg p-3 shadow-none theme-dark-bg" style="width: 98%;">
                            <form class="chat-form" method='POST' enctype="multipart/form-data" id="chat-form">
                                {% csrf_token %}
                                <input type="hidden" name="convid" value='{{chat.conversation.id}}'>
                                <div class='d-flex'>
                                    <input name="attachment" {% if CheckUserStatus %}disabled {% endif %}style='width:150px' multiple='true' type="file">
                                    <input id="chat-message-input" class='bg-secondary' {% if CheckUserStatus %}disabled {% else %} autofocus{% endif %} name='content' type="text" placeholder="type">
                                    <button id="chat-message-submit" type='submit' {% if CheckUserStatus %}disabled{% endif %} class="bg-current"><i class="ti-arrow-right text-white"></i></button>
                                </div>
                            </form>
                        </div> 
                    </div>
                </div>
            </div>
        </div>            
    </div>

{% endblock body %}

{% block scripts %}
    <script>
        const conversationId = "{{ chat.id }}"; 
        const currentUserId = "{{ request.user.id }}"; 
        const currentUsername = "{{ request.user.username }}";
        const protocol = window.location.protocol === "https:" ? "wss" : "ws";
        const chatSocket = new WebSocket(
            protocol + "://" + window.location.host + "/ws/conversations/" + conversationId + "/"
        );
        chatSocket.onmessage = function(e) {
            try {
                const data = JSON.parse(e.data);
                console.log(data)
                if (data.type === 'new_message') {
                    const message = data.message;
                    console.log('New message received:', message);
                    
                    if (message.sender.username === currentUsername) return;
                    
                    const chatBody = document.getElementById('chat-body');
                    const newMessage = createMessageElement(message);
                    chatBody.appendChild(newMessage);
                    
                    scrollToBottomIfNeeded();
                }
            } catch (error) {
                console.error('Error processing WebSocket message:', error);
            }
        };

        chatSocket.onerror = function(error) {
            console.error('WebSocket error:', error);
        };

        function createMessageElement(messageData) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'messages-content pb-5 mb-3';
            
            const safeContent = messageData.content ? 
                messageData.content.replace(/[&<>"'/]/g, char => 
                    ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '/': '&#x2F;'})[char]
                ) : '';
            
            let badgesHTML = '';
            if (messageData.sender.verified) {
                badgesHTML += '<i class="feather-check bg-success font-xs" style="border-radius:50px;"></i>';
            }
            if (messageData.sender.is_admin) {
                badgesHTML += '<i class="feather-check font-xs" style="border-radius:50px; background-color: #FDD017"></i>';
            }
            
            let attachmentsHTML = '';
            if (messageData.attachments && messageData.attachments.length > 0) {
                messageData.attachments.forEach(att => {
                    const safeName = att.name ? 
                        att.name.replace(/[&<>"'/]/g, char => 
                            ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '/': '&#x2F;'})[char]
                        ) : 'File';
                    
                    if (att.type === 'image' || att.type === 'IMAGE') {
                        attachmentsHTML += `
                            <div class="card-body d-block p-0 mb-3">
                                <div class="row ps-2 pe-2">
                                    <div class="col p-1">
                                        <a href="${att.url}" data-lightbox="roadtri">
                                            <img style="max-height: 200px; max-width: 170px" src="${att.url}" class="rounded-3 w-100" alt="image" onerror="this.src='/static/default-image.png'">
                                        </a>
                                    </div>
                                </div>
                            </div>`;
                    } else if (att.type === 'video' || att.type === 'VIDEO') {
                        attachmentsHTML += `
                            <div class="card-body p-0 mb-3 rounded-3 overflow-hidden">
                                <div class="row ps-2 pe-2">
                                    <div class="col-sm p-1">
                                        <video controls style="max-height: 400px">
                                            <source src="${att.url}" type="video/mp4">
                                        </video>
                                    </div>
                                </div>
                            </div>`;
                    } else {
                        attachmentsHTML += `
                            <div class="card-body d-block p-0 mb-3">
                                <div class="row ps-2 pe-2">
                                    <div class="col p-1">
                                        <a style="color:black" href="${att.url}">
                                            <i class="ti-file" style="margin-left:15%; font-size: 80px"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div>${safeName}</div>`;
                    }
                });
            }
            
            messageDiv.innerHTML = `
                <div class="message-item">
                    <div class="message-user">
                        <a href="/profile/${messageData.sender.slug}/">
                            <figure class="avatar">
                                <img src="${messageData.sender.img || '/static/default-avatar.png'}" alt="${messageData.sender.username}" onerror="this.src='/static/default-avatar.png'">
                            </figure>
                        </a>
                        <div>
                            <h5>${messageData.sender.username} ${badgesHTML}</h5>
                            <div class="time">${messageData.timestamp}</div>
                        </div>
                    </div>
                    ${attachmentsHTML}
                    ${safeContent ? `<div class="message-wrap me-2">${safeContent}</div>` : ''}
                </div>
                <div class="clearfix"></div>`;
            
            return messageDiv;
        }

        function scrollToBottomIfNeeded() {
            const scrollContainer = document.querySelector('.chat-wrapper');
            const scrollButton = document.getElementById('scrollToBottomBtn');
            
            if (!scrollContainer) return;
            
            const isNearBottom = scrollContainer.scrollHeight - scrollContainer.scrollTop - scrollContainer.clientHeight <= 100;
            
            if (isNearBottom) {
                scrollContainer.scrollTo({
                    top: scrollContainer.scrollHeight,
                    behavior: 'smooth'
                });
                if (scrollButton) scrollButton.style.display = 'none';
            } else {
                if (scrollButton) scrollButton.style.display = 'flex';
            }
        }

    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const scrollContainer = document.querySelector('.chat-wrapper');
            const scrollButton = document.getElementById('scrollToBottomBtn');
            
            if (!scrollContainer || !scrollButton) return;
            
            setTimeout(() => {
                scrollContainer.scrollTop = scrollContainer.scrollHeight;
                scrollButton.style.display = 'none';
            }, 100);
            
            scrollContainer.addEventListener('scroll', function() {
                const showButton = scrollContainer.scrollTop + scrollContainer.clientHeight < 
                                scrollContainer.scrollHeight - 50;
                
                scrollButton.style.display = showButton ? 'flex' : 'none';
            });
            
            scrollButton.addEventListener('click', function() {
                scrollContainer.scrollTo({
                    top: scrollContainer.scrollHeight,
                    behavior: 'smooth'
                });
            });
            
            window.addEventListener('resize', function() {
                if (scrollContainer.scrollTop + scrollContainer.clientHeight >= 
                    scrollContainer.scrollHeight - 50) {
                    scrollButton.style.display = 'none';
                }
            });
        });
    </script>
{% endblock scripts %}